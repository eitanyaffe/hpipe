# contig coverage matrix
RESPONSE_CONTIG_DONE?=$(RESPONSE_DIR)/.done_contigs
$(RESPONSE_CONTIG_DONE):
	$(call _start,$(RESPONSE_DIR))
	$(_R) R/response.r compute.contig.response \
		ifn=$(CONTIG_TABLE) \
		do.log=$(RESPONSE_LOG) \
		reg=$(RESPONSE_REG) \
		assembly.dir=$(ASSEMBLY_DIR) \
		ids=$(TDATASETS) \
		ofn.observed=$(RESPONSE_CONTIG_OBSERVED) \
		ofn.expected=$(RESPONSE_CONTIG_EXPECTED) \
		norm.reg=$(RESPONSE_CONTIG_NORM_REG) \
		ofn.norm=$(RESPONSE_CONTIG_NORM)
	$(_end_touch)
response_contig: $(RESPONSE_CONTIG_DONE)

# pipe:external: anchor mean response
RESPONSE_ANCHORS_GLOBAL_DONE?=$(RESPONSE_DIR)/.done_anchors_global
$(RESPONSE_ANCHORS_GLOBAL_DONE):
	$(_R) R/response.r compute.anchor.response.global \
		ifn.contigs=$(CONTIG_TABLE) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ifn.norm=$(RESPONSE_CONTIG_NORM) \
		ofn=$(RESPONSE_ANCHOR_GLOBAL)
	$(_end_touch)
response_anchors: $(RESPONSE_ANCHORS_GLOBAL_DONE)

################################################################################
# cluster contigs into elements by repsonse patterns
################################################################################

# contig clustering
RESPONSE_CLUSTER_INIT_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_cluster_init
$(RESPONSE_CLUSTER_INIT_DONE): $(RESPONSE_CONTIG_DONE)
	$(call _start,$(RESPONSE_CLUSTER_DIR))
	$(_R) R/response_cluster.r cluster.contigs \
		ifn=$(RESPONSE_CONTIG_NORM) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		threshold=$(RESPONSE_CLUSTER_THRESHOLD) \
		ofn.table=$(RESPONSE_CONTIG_CLUSTER_INIT) \
		ofn.map=$(RESPONSE_CONTIG_CLUSTER_MAP) \
		ofn.order=$(RESPONSE_CONTIG_ORDER)
	$(_end_touch)
response_cluster_init: $(RESPONSE_CLUSTER_INIT_DONE)

# match clusters and anchors
RESPONSE_CLUSTER_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_cluster
$(RESPONSE_CLUSTER_DONE): $(RESPONSE_CLUSTER_INIT_DONE)
	$(_start)
	$(_R) R/response.r anchor.major \
		ifn.contigs=$(CONTIG_TABLE) \
		ifn.clusters=$(RESPONSE_CONTIG_CLUSTER_INIT) \
		ifn.cluster.map=$(RESPONSE_CONTIG_CLUSTER_MAP) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ofn.major=$(RESPONSE_MAJORS) \
		ofn.clusters.final=$(RESPONSE_CONTIG_CLUSTER)
	$(_end_touch)
response_cluster: $(RESPONSE_CLUSTER_DONE)

################################################################################
# various element properties
################################################################################

# cluster attributes
RESPONSE_INFO_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_info
$(RESPONSE_INFO_DONE): $(RESPONSE_CLUSTER_DONE)
	$(_start)
	$(_R) R/response_info.r info \
		clusters.ifn=$(RESPONSE_CONTIG_CLUSTER) \
		contig.ifn=$(CONTIG_TABLE) \
		coverage.ifn=$(COVERAGE_TABLE) \
		gc.ifn=$(CONTIG_GC_TABLE) \
		gene.ifn=$(GENE_TABLE) \
		uniref.ifn=$(UNIREF_GENE_TAX_TABLE) \
		ca.ifn=$(CA_ANCHOR_CONTIGS) \
		ofn=$(RESPONSE_INFO)
	$(_end_touch)
response_info: $(RESPONSE_INFO_DONE)

RESPONSE_PATTERN_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_pattern
$(RESPONSE_PATTERN_DONE): $(RESPONSE_CLUSTER_DONE)
	$(call _start,$(RESPONSE_CLUSTER_DIR))
	$(_R) R/response.r pattern.response \
		ifn.norm=$(RESPONSE_CONTIG_NORM) \
		ifn.obs=$(RESPONSE_CONTIG_OBSERVED) \
		ifn.exp=$(RESPONSE_CONTIG_EXPECTED) \
		ifn.clusters=$(RESPONSE_CONTIG_CLUSTER) \
		ofn.obs=$(RESPONSE_PATTERN_OBS) \
		ofn.exp=$(RESPONSE_PATTERN_EXP) \
		ofn.mean=$(RESPONSE_PATTERN_MEAN) \
		ofn.top95=$(RESPONSE_PATTERN_TOP95) \
		ofn.bottom05=$(RESPONSE_PATTERN_BOTTOM05) \
		ofn.sd=$(RESPONSE_PATTERN_SD)
	$(_end_touch)
response_pattern: $(RESPONSE_PATTERN_DONE)

RESPONSE_GENES_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_genes
$(RESPONSE_GENES_DONE): $(RESPONSE_CLUSTER_DONE)
	$(_start)
	$(_R) R/response.r element.genes \
		ifn.clusters=$(RESPONSE_CONTIG_CLUSTER) \
		ifn.genes=$(GENE_TABLE) \
		ifn.uniref=$(UNIREF_GENE_TAX_TABLE) \
		ofn=$(RESPONSE_GENES)
	$(_end_touch)
response_genes: $(RESPONSE_GENES_DONE)

$(RESPONSE_ANCHOR_ORDER): $(RESPONSE_CLUSTER_DONE)
	$(_start)
	$(_R) R/response.r response.anchor.order \
		ifn.means=$(RESPONSE_PATTERN_MEAN) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ofn=$@
	$(_end)
response_anchor_order: $(RESPONSE_ANCHOR_ORDER)

################################################################################
# classify genes
################################################################################

RESPONSE_CLASSIFY_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_classify
$(RESPONSE_CLASSIFY_DONE): $(RESPONSE_CLUSTER_DONE)
	$(_start)
	$(_R) R/response_info.r classify \
		clusters.ifn=$(RESPONSE_CONTIG_CLUSTER) \
		contig.ifn=$(CONTIG_TABLE) \
		gene.ifn=$(GENE_TABLE) \
		uniref.ifn=$(UNIREF_GENE_TAX_TABLE) \
		ca.ifn=$(CA_ANCHOR_CONTIGS) \
		ofn=$(RESPONSE_CLASSIFY)
	$(_end_touch)
response_classify: $(RESPONSE_CLASSIFY_DONE)

################################################################################
# element-anchor association
################################################################################

EE_MAP_DONE?=$(EE_BASE_MAP_DIR)/.done_ee_map
$(EE_MAP_DONE):  $(RESPONSE_CLUSTER_DONE)
	$(_start)
	$(MAKE) m=anchors ee_map
	$(_end_touch)
response_map: $(EE_MAP_DONE)

RESPONSE_MATRIX_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_matrix
$(RESPONSE_MATRIX_DONE): $(EE_MAP_DONE)
	$(_start)
	$(_R) R/response.r anchor.matrix \
		ifn.clusters=$(RESPONSE_CONTIG_CLUSTER) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.map=$(EE_MATRIX) \
		ofn=$(RESPONSE_ANCHOR_MATRIX)
	$(_end_touch)
response_matrix: $(RESPONSE_MATRIX_DONE)

RESPONSE_ANCHOR_ELEMENTS_DONE?=$(RESPONSE_CLUSTER_DIR)/.done_anchor_elements
$(RESPONSE_ANCHOR_ELEMENTS_DONE): $(RESPONSE_MATRIX_DONE)
	$(_start)
	$(_R) R/response.r anchor.elements \
		ifn.matrix=$(RESPONSE_ANCHOR_MATRIX) \
		ifn.means=$(RESPONSE_PATTERN_MEAN) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ofn=$(RESPONSE_ANCHOR_ELEMENTS)
	$(_end_touch)
response_elements: $(RESPONSE_ANCHOR_ELEMENTS_DONE)

RESPONSE_NETWORK_DONE?=$(EE_BASE_MAP_DIR)/.done_network
$(RESPONSE_NETWORK_DONE): $(RESPONSE_ANCHOR_ELEMENTS_DONE)
	$(_start)
	$(_R) R/network.r compute.network \
		ifn.elements=$(RESPONSE_ANCHOR_ELEMENTS) \
		ifn.contigs=$(RESPONSE_CONTIG_CLUSTER) \
		ifn.map=$(EE_MATRIX) \
		ifn.element.info=$(RESPONSE_INFO) \
		ifn.majors=$(RESPONSE_MAJORS) \
		min.erichment=$(RESPONSE_NETWORK_MIN_ENRICHMENT) \
		min.contacts=$(RESPONSE_NETWORK_MIN_CONTACTS) \
		max.pearson=$(RESPONSE_NETWORK_MAX_PEARSON) \
		ofn=$(RESPONSE_NETWORK)
	$(_end_touch)
network: $(RESPONSE_NETWORK_DONE)

RESPONSE_SELECT_NETWORK_DONE?=$(EE_BASE_MAP_DIR)/.done_network_select
$(RESPONSE_SELECT_NETWORK_DONE): $(RESPONSE_NETWORK_DONE)
	$(_start)
	$(_R) R/network.r select.network \
		ifn.network=$(RESPONSE_NETWORK) \
		ifn.majors=$(RESPONSE_MAJORS) \
		max.pearson=$(RESPONSE_SELECT_NETWORK_MAX_PEARSON) \
		min.hosts=$(RESPONSE_NETWORK_MIN_HOSTS) \
		min.genes=$(RESPONSE_NETWORK_MIN_GENES) \
		min.uniref.genes=$(RESPONSE_NETWORK_MIN_UNIREF_GENES) \
		min.major.fraction=$(RESPONSE_NETWORK_MIN_MAJOR_FRACTION) \
		ofn=$(RESPONSE_SELECT_NETWORK)
	$(_end_touch)
network_select: $(RESPONSE_SELECT_NETWORK_DONE)

RESPONSE_COORD_NETWORK_DONE?=$(EE_BASE_MAP_DIR)/.done_network_coord
$(RESPONSE_COORD_NETWORK_DONE): $(RESPONSE_SELECT_NETWORK_DONE)
	$(_start)
	$(_R) R/network.r network.coord \
		ifn=$(RESPONSE_SELECT_NETWORK) \
		ofn=$(RESPONSE_NETWORK_COORDS)
	$(_end_touch)
network_coord: $(RESPONSE_COORD_NETWORK_DONE)

RESPONSE_ELEMENTS_FINAL_DONE?=$(EE_BASE_MAP_DIR)/.done_elements_final
$(RESPONSE_ELEMENTS_FINAL_DONE): $(RESPONSE_SELECT_NETWORK_DONE)
	$(_start)
	$(_R) R/network.r elements.final \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.identity=$(ANCHOR_MATRIX_TABLE) \
		ifn.genes=$(RESPONSE_GENES) \
		identity.threshold=$(RESPONSE_ELEMENTS_FINAL_THRESHOLD) \
		ofn.elements=$(RESPONSE_ELEMENTS_FINAL) \
		ofn.genes=$(RESPONSE_GENES_FINAL) \
		ofn.genes.distal=$(RESPONSE_GENES_FINAL_DISTAL)
	$(_end_touch)
elements_final: $(RESPONSE_ELEMENTS_FINAL_DONE)

# use over response class
make_response: $(RESPONSE_CLUSTER_DONE) $(RESPONSE_INFO_DONE) $(RESPONSE_PATTERN_DONE) $(RESPONSE_GENES_DONE) $(SHORTLIST_ELEMENTS) $(RESPONSE_ANCHOR_ORDER) $(RESPONSE_ELEMENTS_FINAL_DONE) $(RESPONSE_COORD_NETWORK_DONE) $(RESPONSE_CLASSIFY_DONE)

# randomize network coords
rnetwork:
	rm -rf $(RESPONSE_NETWORK_DONE)
	@$(MAKE) response

# compare two networks
RESPONSE_COORD_NETWORK_COMPARE_DONE?=$(EE_COMPARE_MAPS_DIR)/.done_network_coord_compare
$(RESPONSE_COORD_NETWORK_COMPARE_DONE):
	$(call _start,$(EE_COMPARE_MAPS_DIR))
	$(_R) R/network.r network.compare.coord \
		ifn1=$(RESPONSE_NETWORK1) \
		ifn2=$(RESPONSE_NETWORK2) \
		ofn=$(RESPONSE_NETWORK_COORDS_COMPARE)
#	$(_end_touch)
response_network_compare: $(RESPONSE_COORD_NETWORK_COMPARE_DONE)

####################################################################
# Genes (currenty not used)
####################################################################

RESPONSE_GO_APPEND_DONE?=$(EE_BASE_MAP_DIR)/.done_GO_append
$(RESPONSE_GO_APPEND_DONE): $(RESPONSE_SELECT_NETWORK_DONE)
	$(_start)
	$(_md)/pl/GO_append.pl \
		$(RESPONSE_GENES_FINAL_DISTAL) \
		$(UNIREF_GENE_GO) \
		$(GO_TREE) \
		$(RESPONSE_GO_TABLE)
	$(_end_touch)
element_GO_append: $(RESPONSE_GO_APPEND_DONE)

# GO abundant across elements
RESPONSE_GO_DONE?=$(EE_BASE_MAP_DIR)/.done_GO
$(RESPONSE_GO_DONE): $(RESPONSE_GO_APPEND_DONE)
	$(_start)
	$(_md)/pl/GO_analysis.pl \
		$(RESPONSE_GO_TABLE) \
		$(RESPONSE_GO_MIN_IDENTITY) \
		$(GO_TREE) \
		$(RESPONSE_GO_SUMMARY_PREFIX)
	$(_end_touch)
element_GO: $(RESPONSE_GO_DONE)

####################################################################
# Sup Figures
####################################################################

# QC for major element
plot_major_control:
	$(_R) R/response_plot.r plot.major.control \
		ifn.contigs=$(CONTIG_TABLE) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.mean=$(RESPONSE_PATTERN_MEAN) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ifn.norm=$(RESPONSE_CONTIG_NORM) \
		fdir=$(RES_FDIR)/major_control


####################################################################
# Figure 3: Host response
####################################################################

plot_response_anchor_distrib:
	$(_R) R/response_plot.r plot.response.anchor.distrib \
		ifn.obs=$(RESPONSE_CONTIG_OBSERVED) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		fdir=$(RES_FDIR)
plot_response_raw:
	$(_R) R/response_plot.r plot.response.matrix \
		ifn.obs=$(RESPONSE_CONTIG_OBSERVED) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ifn.cluster=$(RESPONSE_CONTIG_CLUSTER) \
		ifn.order=$(RESPONSE_CONTIG_ORDER) \
		fdir=$(RES_FDIR)/raw_cluster_analysis
plot_response_raw_anchors:
	$(_R) R/response_plot.r plot.response.matrix.anchor \
		ifn.obs=$(RESPONSE_CONTIG_OBSERVED) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ifn.cluster=$(RESPONSE_CONTIG_CLUSTER) \
		ifn.order=$(RESPONSE_CONTIG_ORDER) \
		ifn.majors=$(RESPONSE_MAJORS) \
		fdir=$(RES_FDIR)/raw_cluster_analysis_anchors
plot_response_anchors:
	$(_R) R/response_plot.r plot.anchor.patterns \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.mean=$(RESPONSE_PATTERN_MEAN) \
		ifn.top95=$(RESPONSE_PATTERN_TOP95) \
		ifn.bottom05=$(RESPONSE_PATTERN_BOTTOM05) \
		ifn.taxa=$(SET_TAXA_REPS) \
		ifn.taxa.legend=$(SET_TAXA_REP_LEGEND) \
		labels=$(TLABELS) \
		fdir=$(RES_FDIR)/complex_patterns
plot_response_vs_identity:
	$(_R) R/response_plot.r plot.response.vs.identity \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.mean=$(RESPONSE_PATTERN_MEAN) \
		ifn.identity=$(ANCHOR_MATRIX_TABLE) \
		fdir=$(RES_FDIR)/complex_patterns

####################################################################
# Figure 4: Element sharing patterns
####################################################################

# 4A: network
plot_network:
	$(_R) R/plot_network.r plot.network \
		lid=$(RESPONSE_LIB_ID) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.coords=$(RESPONSE_NETWORK_COORDS) \
		ifn.taxa.legend=$(SET_TAXA_REP_LEGEND) \
		ifn.element.info=$(RESPONSE_INFO) \
		ifn.classify=$(RESPONSE_CLASSIFY) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/network
replot_network:
	rm -rf $(RESPONSE_COORD_NETWORK_DONE)
	$(MAKE) network_coord plot_network
# 4B/C: degree analysis
plot_network_node_degree:
	$(_R) R/plot_network_props.r plot.node.degree \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.majors=$(RESPONSE_MAJORS) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/network_node_degree
plot_network_host2host_degree:
	$(_R) R/plot_network_props.r plot.host2host.degree \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.majors=$(RESPONSE_MAJORS) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/network_node_degree
# 4E: identity vs sharing
plot_identity_vs_sharing:
	$(_R) R/plot_network_props.r plot.identity.vs.sharing \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.identity=$(ANCHOR_MATRIX_TABLE) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/identity_vs_sharing
# Figure S4-1: element hic-map
plot_hic_map:
	$(_R) R/plot_elements.r plot.hic.map \
		lid=$(RESPONSE_LIB_ID) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.map=$(EE_MATRIX) \
		min.contacts=$(RESPONSE_SELECT_NETWORK_MIN_CONTACTS) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/hic_map

# Figure S4-3: GO enrichments
plot_GO:
	$(_R) R/plot_GO.r plot.GO.elements \
		ifn.prefix=$(RESPONSE_GO_SUMMARY_PREFIX) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/GO

plot_fig4: plot_network plot_network_node_degree plot_network_host2host_degree plot_identity_vs_sharing plot_hic_map plot_GO

####################################################################
# Figure 5: Network changes due to cipro
####################################################################

# (S)
plot_hic_map_compare_matrix:
	$(_R) R/plot_map_compare.r plot.hic.map.compare.matrix \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.network1=$(RESPONSE_NETWORK1) \
		ifn.network2=$(RESPONSE_NETWORK2) \
		ifn.map1=$(EE_MATRIX1) \
		ifn.map2=$(EE_MATRIX2) \
		min.contacts=$(RESPONSE_NETWORK_MIN_CONTACTS) \
		fdir=$(RES_FDIR)/datasets/hic_map_compare/$(RESPONSE_COMPARE_ID)

# Fig 5A
plot_hic_map_compare_network:
	$(_R) R/plot_map_compare.r plot.hic.map.compare.network \
		ifn.coords=$(RESPONSE_NETWORK_COORDS_COMPARE) \
		ifn.response=$(RESPONSE_PATTERN_MEAN) \
		ifn.majors=$(RESPONSE_MAJORS) \
		ifn.network1=$(RESPONSE_NETWORK1) \
		ifn.network2=$(RESPONSE_NETWORK2) \
		ifn.map1=$(EE_MATRIX1) \
		ifn.map2=$(EE_MATRIX2) \
		min.contacts=$(RESPONSE_NETWORK_MIN_CONTACTS) \
		min.enrichment=$(RESPONSE_NETWORK_MIN_ENRICHMENT) \
		fdir=$(RES_FDIR)/datasets/hic_map_compare/$(RESPONSE_COMPARE_ID)

plot_hic_map_compare: plot_hic_map_compare_matrix plot_hic_map_compare_network

# (S) element coverage profiles
plot_network_elements:
	$(_R) R/plot_network.r plot.network.elements \
		lid=$(RESPONSE_LIB_ID) \
		ifn.network=$(RESPONSE_SELECT_NETWORK) \
		ifn.obs=$(RESPONSE_PATTERN_OBS) \
		ifn.exp=$(RESPONSE_PATTERN_EXP) \
		reg=$(RESPONSE_REG) \
		labels=$(TLABELS) \
		fdir=$(RES_FDIR)/datasets/$(RESPONSE_LIB_ID)/network_element

# over anchor
response_plots_anchor: plot_response_anchor_distrib plot_response_raw plot_response_raw_anchors plot_response_anchors plot_response_vs_identity

# over response
response_plots_response: plot_hic_map plot_network plot_network_elements

####################################################################
# Experimental plots
####################################################################

# scatter of CA contact enrichment vs CA temporal correlation
plot_contact_vs_temporal:
	$(_R) R/response_plot.r plot.contact.vs.temporal \
		ifn.contigs=$(CONTIG_TABLE) \
		ifn.ca=$(CA_ANCHOR_CONTIGS) \
		ifn.matrix=$(CA_MATRIX) \
		min.contacts=$(CA_MIN_CONTACTS) \
		ifn.norm=$(RESPONSE_CONTIG_NORM) \
		ifn.anchors=$(RESPONSE_ANCHOR_GLOBAL) \
		fdir=$(RES_FDIR)/contact_vs_temporal


response_init: $(CORRELATE_CLUSTER_BINARY) $(COVERAGE_KMEANS_BINARY)

